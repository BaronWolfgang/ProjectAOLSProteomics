# Decrypting the molecular basis of cellular drug phenotypes by dose-resolved expression proteomics
A very interesting article that demonstrates the Omics (with a capital O) character of Proteomics is [Decrypting the molecular basis of cellular drug phenotypes by dose-resolved expression proteomics](https://pmc.ncbi.nlm.nih.gov/articles/PMC11919725/){.uri}, published in Nature Biotechnology in March 2024. Here, the authors measure the protein expression of more than 8000 protein groups after exposing cell lines to 144 different drugs for a period of 18 hours. They use this data to calculate dose response curves for all of the proteins.

Please familiarize yourself with the article, we'll try to reproduce some plots from it.

# Software needed
## File download software
For downloading the data you will need an FTP (file transfer protocol) client. For windows, you can obtain Filezilla client (take care not to install extra software that is sometimes offered in the installer). Macintosh users have a built-in FTP client under connect to server, prefix the URL with ftp://.

## R
Since you are reading this in Rmd, it should be obvious you need R and probably RStudio. The following packages need to be installed: drc for dose response curve calculation tidyverse packages: readr, readxl, tidyr, dplyr, purrr, ggplot2

```{r}
base_packages_to_install <- c(
  "readr",
  "readxl",
  "tidyr",
  "dplyr",
  "purrr",
  "ggplot2",
  "drc"
)

my_packages_to_install <- c(
  "conflicted",
  "RCurl",
  "magrittr",
  "stringr",
  "broom",
  "tibble",
  "pheatmap",
  "fuzzyjoin",
  "scales",
  "colorspace"
  
)

BiocManager_packages_to_install <- c(
  "clusterProfiler", #GO term enrichment analysis from paper
  "org.Hs.eg.db",
  "enrichplot"
)

packages_to_install <- c(base_packages_to_install, my_packages_to_install)

# Check and install packages using a for loop
for (package in packages_to_install) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
  library(package, character.only = TRUE)
}

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("desc", "dplyr")
conflict_prefer("rename", "clusterProfiler")


if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

for (package in BiocManager_packages_to_install) {
  if (!requireNamespace(package, quietly = TRUE)) {
    BiocManager::install(package)
  }
  library(package, character.only = TRUE) 
}
```

## Data
We'd like to re-analyze some data from this article, to try to recreate some dose-response curves. The data is stored in ProteomeXChange, but unfortunately the R package does not support the repository (MassIVE), so we'll need to do some manual work.

In the article, a reference to the dataset is available. Obtain the proteinGroups.txt file from the time dependent dataset.

A 500 Megabytes file with proteinGroups at an FDR of 0.01 can be found in the FTP server of MassIVE in this folder: "/v06/MSV000093659/search/Search results - Long-term performance test Jurkat"

```{r}
# Define folder name
data_dir <- "data"

# Create folder if it doesn't exist
if (!dir.exists(data_dir)) {
  dir.create(data_dir)
  cat("Created 'data' folder\n")
} else {
  cat("'data' folder already exists\n")
}
```

```{r}
txt_file <- paste0(data_dir,"/proteinGroups_fdr0.01.txt")

if (!file.exists(txt_file)) {
  # If the file does not exist, download it
  ftp_url_txt <- URLencode("ftp://massive-ftp.ucsd.edu/v06/MSV000093659/search/Search results - Long-term performance test Jurkat/Picked FDR PG/proteinGroups_fdr0.01.txt")
  download.file(ftp_url_txt, destfile = txt_file, mode = "wb")
  cat("Downloaded proteinGroups_fdr0.01.txt to 'data/' folder\n")
} else {
  cat("File already exists in 'data/' folder, skipping download.\n")
}
```

Read the file into R. Rename the headers of the Gene names table to be more easily used in the rest of the script.
```{r}
doseresponse <- read_delim(txt_file) %>%
  dplyr::rename(Genes = `Gene names`)
head(doseresponse)
```

The drug names are given as numbers, so we will need to obtain the names from the metadata data found in the MassIVE repository.
```{r}
xlsx_file <- file.path(data_dir, "MassIVE_MappingSheet.xlsx")

if (!file.exists(xlsx_file)) {
  ftp_url_xlsx <- URLencode(
    "ftp://massive-ftp.ucsd.edu/v06/MSV000093659/metadata/MassIVE_MappingSheet.xlsx"
  )
  download.file(ftp_url_xlsx, destfile = xlsx_file, mode = "wb")
  cat("Downloaded MassIVE_MappingSheet.xlsx to 'data/' folder\n")
} else {
  cat("File 'MassIVE_MappingSheet.xlsx' already exists, skipping download.\n")
}

drugs <- read_xlsx(xlsx_file, sheet=2, skip=1, col_names = c("Drug", "Number")) %>% 
  pull(Drug)
```

If you have a look at the dimensions of the dataset, it's clear that there are a massive amount of columns. 

```{r}
dim(doseresponse)
```

We don't need all of them, use the tidyverse `select` function to obtain the colums that contain protein names, descriptions, and LFQ values.
```{r}
head(doseresponse)
```


```{r}
dmso <- doseresponse %>%
  select(Genes, starts_with("LFQ") & contains("DMSO"))

doseresponse <- doseresponse %>%
  select(c(Genes), starts_with("LFQ")) %>%
  select(-(contains("DMSO")))
```

## Tidying and normalization
Use dplyr to make a long-form dataset with the data points coming from the LFQ columns. We'll need to split the column names into their separate parts, this can be done with the `separate` command.

According to the methods, the protein values are divided by the mean DMSO expression value.
```{r}
# Check if the RDS file exists
if (file.exists("doseresponse_norm.rds")) {
  # Load the doseresponse_norm dataset from the RDS file if it exists
  doseresponse_norm <- readRDS("doseresponse_norm.rds")
} else {
  # If the RDS file does not exist, run the code to create the dataset
  dmso_tidy <- dmso %>% 
    pivot_longer(-Genes) %>% 
    summarize(.by=Genes, mean_dmso = mean(value, na.rm=TRUE)) %>% 
    select(Genes, mean_dmso)

  tidy_doseresponse <- doseresponse %>%
    pivot_longer(starts_with("LFQ")) %>%
    separate(name, sep=" ", into=c(NA, NA, "compound", "dose")) %>%
    mutate(compound = drugs[as.numeric(compound)], dose = as.numeric(dose))

  tidy_doseresponse %<>% left_join(dmso_tidy, by="Genes")

  doseresponse_norm <- tidy_doseresponse %>%
    mutate(.by=c(Genes, compound), value = value / mean_dmso) %>%
    select(-mean_dmso)

  # Save the doseresponse_norm dataset as an RDS file for future use
  saveRDS(doseresponse_norm, "doseresponse_norm.rds")
}
```

We also need to add a zero-concentration value for the curves, so we have a common starting point.
```{r}
zero_values <- doseresponse_norm %>% summarize(.by = c(Genes, compound), dose=0.1, value=1)

doseresponse_norm %<>% bind_rows(zero_values)
```

Remove the raw data from the environment
```{r}
remove(dmso)
remove(doseresponse)
remove(zero_values)
```


### Example plot
Here is an example plot reproduction of the article.
```{r, example}
doseresponse_norm %>%
  filter(
    Genes %in% c("BAG3", "DNAJB1", "DNAJB4", "HSPA1A;HSPA1B"),
    compound =="Geldanamycin"
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10()
```

#### redoing example
NOTE: I don't see DNAJB1 or DNAJB2 at all:
```{r}
doseresponse_norm %>% select(Genes) %>% unique() %>% filter(str_detect(Genes, "DNAJB")) %>% arrange(Genes)
```
```{r, adjusted}
selected_genes <- c("BAG3", "DNAJB11", "DNAJB14", "HSPA1A;HSPA1B")
selected_compounds <- c("Geldanamycin")

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )
```

# Assignment
Given this dataset, try to do the following:
- Reproduce some of the dose-response curves, or try to find some that have proteins that have relatively high or low values in the higher drug concentration regimes
- Create a heatmap for the proteins for one or more selected drugs, across the relative concentration range
Perform hierarchical clustering separately for the clusters you observe, have a look over here: https://www.statology.org/hierarchical-clustering-in-r/
- use a GO annotation tool to find out if you observe some interesting enrichment in your clusters, and try to link the action of the drug(s) to the observed terms.

## 1. Reproducing dose-response curves
Generalized curve plotting methods:
```{r}
selected_genes <- c("BAG3", "DNAJB11", "DNAJB14", "HSPA1A;HSPA1B")
selected_compounds <- c("Geldanamycin")
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1] #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::trans_format("log10", scales::math_format(10^.x)),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )
```

### random subset
```{r}
length(unique(doseresponse_norm$Genes))
length(unique(doseresponse_norm$compound))
```

```{r}
set.seed(123)

selected_genes <- sample(unique(doseresponse_norm$Genes), 5)
selected_compounds <- sample(unique(doseresponse_norm$compound), 9)
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1] #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::trans_format("log10", scales::math_format(10^.x)),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )
```

### Manual checking
```{r}
doseresponse_norm %>% select(Genes) %>% unique() %>% 
  filter(str_detect(Genes, "RRM")) %>% 
  arrange(Genes)

doseresponse_norm %>% select(compound) %>% unique() %>% 
  #filter(str_detect(compound, "")) %>% 
  arrange(compound)
```

```{r}
#Selected genes and compounds from Fig.3a
selected_genes <- c("HDAC1", "RRM2", "BAG3", "DNMT1", "DHFR")
selected_compounds <- c("Vorinostat", "Palbociclib", "Carfilzomib", "Decitabine", "Methotrexate")
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1]  #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::trans_format("log10", scales::math_format(10^.x)),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )

ggsave(
    filename = "plots/figure_3a.jpg",
    dpi = 300,
    width = 7,
    height = 4
)

figure_3a_map <- data.frame(
  compound = selected_compounds,
  Genes = selected_genes
)



doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  semi_join(figure_3a_map, by = c("compound", "Genes")) %>%
  ggplot(aes(x=dose, y=value, col = Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::trans_format("log10", scales::math_format(10^.x)),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = rep(palette.colors()[6], length(selected_genes))) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(compound~Genes, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line(),
      legend.position = "none"
    )

```

```{r}
#Selected genes and compounds from Fig.3b
selected_genes <- doseresponse_norm %>% select(Genes) %>% unique() %>% 
  filter(str_detect(Genes, "CLK")) %>% 
  arrange(Genes) %>% pull()
selected_compounds <- c("Brigatinib")
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1]  #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::trans_format("log10", scales::math_format(10^.x)),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    ) 
```


## 2. Create heatmap
For the heatmap in the paper: The heatmap depicts the combined, preprocessed GO term enrichment results after hierarchically clustering of both rows and columns using Pearson correlation as a distance metric and Weighted Pair Group Method with arithmetic mean as the agglomerative method.

### most differential compounds
#### Comparison data
```{r}
comparison_data <- doseresponse_norm %>%
  filter(!is.na(value), #there are 3,060 na's
         is.finite(value) 
         ) %>%
  distinct(compound, Genes, dose, .keep_all = TRUE) %>%
  select(compound, Genes, dose, value) %>%
  arrange(compound, Genes, dose) %>%
  ungroup()

comparison_data
```

```{r}
comparison_data_wide <- comparison_data %>%
  pivot_wider(names_from = dose, values_from = value, names_prefix = "dose_") %>%
  { .[!apply(select(., starts_with("dose_1")), 1, function(x) all(is.na(x) | x == 0)), ] } %>%
  mutate(
    across(starts_with("dose_"), 
           ~ log2(. / dose_0.1), 
           .names = "log2FC_{str_remove(.col, 'dose_')}"),
    regulation = case_when(
      log2FC_10000 > log2(1.5) ~ "upregulated",
      log2FC_10000 < log2(0.7) ~ "downregulated", 
      TRUE ~ "not_regulated"
    )
  ) 

comparison_data_wide
```


#### Genecount
```{r}
comparison_data_summary <- comparison_data_wide %>% 
  group_by(compound) %>%
  summarize(
    upregulated = sum(regulation == "upregulated"),
    downregulated = sum(regulation == "downregulated"),
    not_regulated = sum(regulation == "not_regulated")
  ) %>%
  mutate(total_genes = upregulated + downregulated + not_regulated) %>%
  ungroup() %>%
  arrange(not_regulated) 

comparison_data_summary

compound_ranked_regulated <- comparison_data_summary %>% pull(compound) 

#Fix compound ordering
comparison_data <- comparison_data %>% 
  mutate(compound = factor(compound, levels=compound_ranked_regulated))

comparison_data_summary <- comparison_data_summary %>%
  mutate(compound = factor(compound, levels=compound_ranked_regulated))

```

```{r,fig.width=14} 
comparison_data_summary %>%
  mutate(
    label_y = ifelse(
      upregulated < downregulated,
      upregulated + 10,            
      -downregulated - 10      
    ),
    label_hjust = ifelse(
      upregulated < downregulated,
      0, 1
    )
  ) %>%
  ggplot(aes(x = compound)) +
  geom_bar(aes(y = upregulated, fill = "Upregulated"), stat = "identity") +
  geom_bar(aes(y = -downregulated, fill = "Downregulated"), stat = "identity") +
  scale_y_continuous(
    limits = c(-9000,5000),
    expand = c(0,0),
    breaks =seq(-9000, 5000, by = 1000)
  ) +
  scale_fill_manual(values = c("Downregulated" = "#56B4E9", "Upregulated" = "#CC79A7")) +
  geom_text(
    aes(y = label_y, label = compound, hjust = label_hjust),
    angle = 90, vjust = 0.35, size = 3
    ) +
  theme_bw() +
  labs(y="Number of genes",
       x="") +
  theme(
    #axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),  
    axis.line = element_line(),          
    axis.ticks = element_line(),
    
    legend.text = element_text(size = 20),
    legend.title = element_blank(),
    legend.position = c(0.99,0.01),
    legend.justification = c("right", "bottom"),
    legend.background = element_blank()
  ) +
  guides(fill = guide_legend(reverse = TRUE))
```

#### compound Mechanism of Action
taken from: https://www.proteomicsdb.org/search?q=&type=Drug&projectId=4489
```{r}
MechanismofAction <- read.csv("data/drug_search_.csv")
MechanismofAction
```

```{r}
compound_ranked_regulated
```


```{r}
compounds_with_MoA <- stringdist_full_join(
  data.frame(compound = unique(compound_ranked_regulated)),
  MechanismofAction, 
  by=c("compound" = "Name"),
  method = "jw",
  max_dist=0.08,
  distance_col = "dist") %>%
  select(compound, Type) %>%
  mutate(Type_simp = case_when(
    Type == "Hormone-like" ~ "Other",
    Type == "CytP450 inhibitor " ~ "Other",
    Type == "Calcineurin inhibitor" ~ "Other",
    Type == "HDMi" ~ "Other",        
    Type == "MTi" ~ "Methyltr. inhibitor",    
    Type == "NFAT activation inhibitor" ~ "Other",    
    TRUE ~ Type
    ),
    Type_simp = str_replace(Type_simp, "inhibitor", "inh."),
    compound = factor(compound, levels=compound_ranked_regulated),
    
    Type_simp_s =  case_when(
      Type_simp == "BET inh." ~ "Other",
      Type_simp == "CytP450 inh." ~ "Other",
      Type_simp == "HSP90 inh." ~ "Other",
      Type_simp == "SIRT inh." ~ "Other",        
      Type_simp == "Proteasome inh." ~ "Other",    
      Type_simp == "Mitotic inh." ~ "Other",    
      TRUE ~ Type_simp
    )
  )

compounds_with_MoA

```

#### with compound annotation
```{r, fig.width=14}
comparison_data_summary %>% 
  left_join(compounds_with_MoA) %>%
  mutate(
    compound = factor(compound, levels=compound_ranked_regulated),
    label_y = ifelse(
      upregulated < downregulated,
      upregulated + 10,            
      -downregulated - 10      
    ),
    label_hjust = ifelse(
      upregulated < downregulated,
      0, 1
    )
  ) %>%
  ggplot(aes(x = compound)) +
  geom_bar(aes(y = upregulated, fill = "Upregulated"), stat = "identity") +
  geom_bar(aes(y = -downregulated, fill = "Downregulated"), stat = "identity") +
  scale_y_continuous(
    limits = c(-9000,5000),
    expand = c(0,0),
    breaks =seq(-9000, 5000, by = 1000)
  ) +
  scale_fill_manual(values = c("Downregulated" = "#56B4E9", "Upregulated" = "#CC79A7")) +
  geom_text(
    aes(y = label_y, label = compound, hjust = label_hjust),
    angle = 90, vjust = 0.35, size = 3
    ) +
  theme_bw() +
  labs(y="Number of genes",
       x="") +
  
  geom_point(aes(y=-8900, col=Type_simp_s), size=2 ) +
  
  theme(
    #axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.5),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),  
    axis.line = element_line(),          
    axis.ticks = element_line(),
    
    legend.text = element_text(size = 20),
    legend.title = element_blank(),
    legend.position = c(0.99,0.05),
    legend.justification = c("right", "bottom"),
    legend.background = element_rect(color = "black", fill = "white")
  ) +
  guides(
    fill = guide_legend(reverse = TRUE),
    col = guide_legend(ncol = 4)  # Split color legend into 2 columns
  )
```

#### Grouped by type
```{r, fig.width=28}
# Combine all drug types into a single plot with facets
full_comp <- comparison_data_summary %>%
    left_join(compounds_with_MoA)

type_counts <- compounds_with_MoA %>%
    count(Type, name = "drug_type_count") %>%
    arrange(desc(drug_type_count))

# Update drug types with less than 5 counts to "Other"
full_comp <- full_comp %>%
    mutate(Type = ifelse(Type %in% type_counts$Type[type_counts$drug_type_count < 5], "Other", Type))

type_counts <- full_comp %>%
    count(Type, name = "drug_type_count") %>%
    arrange(desc(drug_type_count))

# Create a new factor for compound with levels ordered by drug type
full_comp <- full_comp %>%
    mutate(
        compound = factor(compound, levels = compound_ranked_regulated),
        drug_type_group = factor(Type, levels = type_counts$Type)
    )

# Count the number of compounds in each drug type group
drug_type_counts <- full_comp %>%
    group_by(drug_type_group) %>%
    summarize(compound_count = n_distinct(compound)) %>%
    ungroup()

# Generate a color palette for facets
facet_colors <- scales::hue_pal()(length(unique(full_comp$drug_type_group)))

ggplot(full_comp, aes(x = compound)) +
    geom_rect(
        aes(
            xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = drug_type_group
        ),
        inherit.aes = FALSE, alpha = 0.2,
        data = full_comp %>% distinct(drug_type_group),
        show.legend = FALSE  # Exclude facet-based color fill from the legend
    ) +
    geom_bar(aes(y = upregulated, fill = "Upregulated"), stat = "identity", show.legend=FALSE) +
    geom_bar(aes(y = -downregulated, fill = "Downregulated"), stat = "identity", show.legend=FALSE) +

    geom_text(
        aes(
            y = ifelse(upregulated < downregulated, upregulated + 10, -downregulated - 10),
            label = compound,
            hjust = ifelse(upregulated < downregulated, 0, 1)
        ),
        angle = 90, vjust = 0.35, size = 4.5
    ) +
  
    geom_point(aes(x=1,y=1, shape = "Upregulated"), size=0) +
    geom_point(aes(x=1,y=1, shape = "Downregulated"), size=0) +
  
    scale_shape_manual(values = c("Upregulated" = 22, "Downregulated" = 22) ,breaks = c("Upregulated", "Downregulated")) +
  
    scale_y_continuous(
      limits = c(-9000, 5000),
      expand = c(0, 0),
      breaks = seq(-9000, 5000, by = 1000)
    ) +
  
    facet_grid(
        ~ drug_type_group,
        scales = "free_x",
        space = "free_x",
        labeller = label_wrap_gen(width = 10)
    ) +
  
    scale_fill_manual(
        values = c(
            "Upregulated" = "#CC79A7",
            "Downregulated" = "#56B4E9",
            setNames(facet_colors, levels(full_comp$drug_type_group))
        )
    ) +
    labs(
        y = "Number of regulated proteins",
        x = "",
        fill = "Regulation",
        #title = "Proteins Regulated by Drug Type"
    ) +
  
    theme_bw() +

    theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 24),
        axis.text.y = element_text(size = 20),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(),
        axis.ticks = element_line(),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 16), # Adjust facet label text size
        panel.background = element_rect(fill = "white", colour = "white"),
        
        legend.text = element_text(size = 20),
        legend.title = element_blank(),
        legend.position = c(0.99,0.05),
        legend.justification = c("right", "bottom"),
        legend.background = element_rect(color = "black", fill = "white")
    ) +
    guides(
      shape = guide_legend(
        override.aes = list(
          fill = c("#CC79A7", "#56B4E9"),
          labels = c("Upregulated", "Downregulated"),
          size = 10
          )
        )
    )
  
    #guides(
    #    fill = guide_legend(
    #        override.aes = list(
    #        fill = c("#CC79A7", "#56B4E9", rep(NA, length(facet_colors))),
    #        size = c(1,1,rep(0, length(facet_colors))),
    #        shape = c(16, 16, rep(NA, length(facet_colors)))
    #        )
    #    )
    #)

ggsave(
    filename = "plots/all_drug_up_down.png",
    dpi = 300,
    width = 28,
    height = 14
)
```


### Heatmap
#### per compound heatmapping
```{r}
doseresponse_log2FC <- comparison_data_wide %>%
  select(compound, Genes, starts_with("log2FC"), -log2FC_0.1) %>%
  pivot_longer(
    cols = starts_with("log2FC"), 
    names_to = "dose", 
    values_to = "log2FC",
    names_transform = list(dose = ~ str_remove(., "log2FC_"))
  ) %>%
  left_join(compounds_with_MoA)  %>%
  arrange(compound) %>%
  mutate(
    compound = factor(compound, levels = compound_ranked_regulated)
  )

doseresponse_log2FC
```

Getting colours by using the type and then shifting using the specific compound
```{r}
## Simp
facet_colors_2 <- c(
  "HDAC inh." = "#CD9600",
  "Kinase inh." = "#F8766D",
  "Other" = "#7CAE00",
  "E3 ligase ligands" = "#00A9FF",
  "Mitotic inh."= "#7CAE00",
  "Methyltr. inh." = "#FF61CC"    ,
  "Proteasome inh." = "#7CAE00", 
  "PARP inh." = "#C77CFF",
  "Chemo drug"  = "#00BFC4",
  "SIRT inh."   = "#7CAE00", 
  "HSP90 inh." = "#7CAE00", 
  "BET inh." = "#7CAE00", 
  "CytP450 inh."  = "#7CAE00"
)

## Simp_s
facet_colors_1 <- c(
  "HDAC inh." = "#CD9600",
  "Kinase inh." = "#F8766D",
  "Other" = "#7CAE00",
  "E3 ligase ligands" = "#00A9FF",
  "Methyltr. inh." = "#FF61CC"    ,
  "Chemo drug"  = "#00BFC4",
  "PARP inh." = "#C77CFF",
  "Small molecule" = "#00BE67"
)

```

#### top n
```{r, fig.width=14}
n_compounds <- 10
selected_compounds <- compound_ranked_regulated[1:n_compounds]

heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group) <- colnames(heatmap_data_matrix)

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group$Type)])

colnames(compound_group) <- "Type"

# Plot
pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC for top ", n_compounds, " compounds"),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_col = compound_group, 
  annotation_colors = subset_colors,
  #annotation_names_col = FALSE, 
  legend_labels = c("Compound", "Type") 
)
```



```{r, fig.width=14}
n_compounds <- 10
selected_compounds <- compound_ranked_regulated[1:n_compounds]

heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  .[!apply(., 1, function(x) all(is.infinite(x) | is.na(x))), ] %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group) <- colnames(heatmap_data_matrix)

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group$Type)])

colnames(compound_group) <- "Type"

# Plot
pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC for top ", n_compounds, " compounds"),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_col = compound_group, 
  annotation_colors = subset_colors,
  #annotation_names_col = FALSE, 
  legend_labels = c("Type") 
)
```

##### stringent
```{r, fig.width=14}
n_compounds <- 10
selected_compounds <- compound_ranked_regulated[1:n_compounds]

heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  .[rowSums(. == -Inf, na.rm = TRUE) == 0 & rowSums(is.na(.)) < ncol(.), ] %>%
  mutate(
    across(
      everything(),
     ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
    )
  ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group) <- colnames(heatmap_data_matrix)

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group$Type)])

colnames(compound_group) <- "Type"

# Plot
pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC for top ", n_compounds, " compounds"),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_col = compound_group, 
  legend_labels = "Type",
  annotation_colors = subset_colors
)

ggsave(
    filename = "plots/top10compounds.png",
    dpi = 300,
    width = 14,
    height = 7
)
```

##### all vs all
```{r, fig.width=14}
n_compounds <- length(compound_ranked_regulated)
selected_compounds <- compound_ranked_regulated[1:n_compounds]

heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  .[!apply(., 1, function(x) all(is.infinite(x) | is.na(x))), ] %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group) <- colnames(heatmap_data_matrix)

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group$Type)])

colnames(compound_group) <- "Type"

# Plot
pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC for all compounds"),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = FALSE,
  annotation_col = compound_group, 
  annotation_colors = subset_colors,
  #annotation_names_col = FALSE, 
  legend_labels = c("Type") 
)

ggsave(
    filename = "plots/all_compounds_all_concentrations.png",
    dpi = 300,
    width = 14,
    height = 7
)
```

```{r, fig.width=14}
n_compounds <- length(compound_ranked_regulated)
selected_compounds <- compound_ranked_regulated[1:n_compounds]

heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  .[rowSums(. == -Inf, na.rm = TRUE) == 0 & rowSums(is.na(.)) < ncol(.), ] %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group) <- colnames(heatmap_data_matrix)

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group$Type)])

colnames(compound_group) <- "Type"

# Plot
pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC for all compounds"),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = FALSE,
  annotation_col = compound_group, 
  annotation_colors = subset_colors,
  #annotation_names_col = FALSE, 
  legend_labels = c("Type") 
)

ggsave(
    filename = "plots/all_compounds_all_concentrations_stringent.png",
    dpi = 300,
    width = 14,
    height = 7
)
```


### compared to baseline heatmap 
```{r, fig.width=14}
selected_dose <- 10000

heatmap_full <- doseresponse_log2FC %>%
  filter(dose == selected_dose) %>%
  select(Genes, compound, log2FC) %>%
  pivot_wider(names_from = compound, values_from = log2FC) 

heatmap_full_matrix <- heatmap_full %>%
  filter(!is.na(Genes)) %>%
  distinct(Genes, .keep_all = TRUE) %>%
  column_to_rownames("Genes") %>%
  .[!apply(., 1, function(x) all(is.infinite(x) | is.na(x))), ] %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

compound_group_full <- data.frame(
  compound = colnames(heatmap_full_matrix)
  ) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group_full) <- colnames(heatmap_full_matrix)

colnames(compound_group_full) <-"Type"

compound_group_full

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group_full$Type)])

pheatmap(
  heatmap_full_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC ", selected_dose, " (nm)"),
  na_col = "grey80",
  show_rownames = F,  # Remove row labels
  show_colnames = F,   # Remove column labels
  annotation_col = compound_group_full,
  annotation_colors = subset_colors,
  legend_labels = "Type" 
)
```

```{r, fig.width=14}
selected_dose <- 10000

heatmap_full <- doseresponse_log2FC %>%
  filter(dose == selected_dose) %>%
  select(Genes, compound, log2FC) %>%
  pivot_wider(names_from = compound, values_from = log2FC) 

heatmap_full_matrix <- heatmap_full %>%
  filter(!is.na(Genes)) %>%
  distinct(Genes, .keep_all = TRUE) %>%
  column_to_rownames("Genes") %>%
  .[rowSums(. == -Inf | is.na(.)) == 0, ] %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

compound_group_full <- data.frame(
  compound = colnames(heatmap_full_matrix)
  ) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group_full) <- colnames(heatmap_full_matrix)

colnames(compound_group_full) <-"Type"

compound_group_full

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group_full$Type)])

pheatmap(
  heatmap_full_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC ", selected_dose, " (nm)"),
  na_col = "grey80",
  show_rownames = F,  # Remove row labels
  show_colnames = F,   # Remove column labels
  annotation_col = compound_group_full,
  annotation_colors = subset_colors,
  legend_labels = "Type" 
)
```

```{r, fig.width=14}
selected_dose <- 100

heatmap_full <- doseresponse_log2FC %>%
  filter(dose == selected_dose) %>%
  select(Genes, compound, log2FC) %>%
  pivot_wider(names_from = compound, values_from = log2FC) 

heatmap_full_matrix <- heatmap_full %>%
  filter(!is.na(Genes)) %>%
  distinct(Genes, .keep_all = TRUE) %>%
  column_to_rownames("Genes") %>%
  .[!apply(., 1, function(x) all(is.infinite(x) | is.na(x))), ] %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

compound_group_full <- data.frame(
  compound = colnames(heatmap_full_matrix)
  ) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp_s),
            by = "compound") %>%
  select(-compound)
rownames(compound_group_full) <- colnames(heatmap_full_matrix)

colnames(compound_group_full) <-"Type"

compound_group_full

subset_colors <- list(Type = facet_colors_1[names(facet_colors_1) %in% unique(compound_group_full$Type)])

pheatmap(
  heatmap_full_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC ", selected_dose, " (nm)"),
  na_col = "grey80",
  show_rownames = F,  # Remove row labels
  show_colnames = F,   # Remove column labels
  annotation_col = compound_group_full,
  annotation_colors = subset_colors,
  legend_labels = "Type" 
)
```



## 3. Gene annotation
In the paper GO term enrichment analysis was performed for each drug individually using the clusterProfiler R package (v.4.2.2.). Each drug dataset was tested for enrichment of GO terms on all levels (cellular compartment, molecular function and biological process) both in up- and down-regulated proteins with the whole drug dataset as the background. P values were corrected using the FDR approach and the q value cut-off was set to 1. The enrichment results for up-and down-regulation were combined, retaining the more significant entry for duplications. After combining the enrichment results for all drugs, the q values were log transformed, multiplied by âˆ’1 for GO terms enriched in down-regulation and z-scored for each GO term individually

A second GO term enrichtment analysis was done(P value cut-off, 0.05; P value correction, FDR approach; Subontology, Molecular Function; whole H. sapiens database as background)

Either clusterProfiler or topGO for GO term enrichtment.
### Marloes (all annotations)
```{r}
all_genes <- doseresponse_log2FC %>% pull(Genes) %>% unique()

gene_ids <- bitr(all_genes, fromType="SYMBOL", toType="ENTREZID", OrgDb=org.Hs.eg.db)

go_slim <- enrichGO(gene          = gene_ids$ENTREZID,
                    OrgDb         = org.Hs.eg.db,
                    keyType       = "ENTREZID",
                    ont           = "BP", # Biological Process
                    readable      = TRUE,
                    pool          = TRUE)
go_slim_df <- as.data.frame(go_slim)

go_slim_df %>% arrange(desc(Count)) 

#go_slim_simp <- clusterProfiler::simplify(
#  go_slim,
#  cutoff = 0.3,
#  by = "p.adjust",
#  select_fun = min,
#  measure = "Wang"
#)

#go_slim_simp_df <- as.data.frame(go_slim_simp)

go_long <- go_slim_df %>%
  select(ID, Description, geneID, Count) %>%
  separate_rows(geneID, sep = "/") %>%
  mutate(Genes = geneID) %>%
  select(Genes, ID, Description, Count)
  #rename(GeneSymbol = geneID,
  #       GO_Category_ID = ID,
  #       GO_Category_Description = Description)

# Check result
go_long %>% select(ID) %>% unique() %>% pull() %>% length()
```


```{r}
GO_group_biggest <- go_long %>%
  group_by(Genes) %>%
  slice_max(order_by = Count, n=1, with_ties = FALSE) %>%
  arrange(desc(Count)) %>%
  select(-ID,Count)

#GO_group_biggest %>% pull(Description) %>% table()
```

### heatmap with annotated genes
```{, fig.width=14}
selected_dose <- 10000

heatmap_full <- doseresponse_log2FC %>%
  filter(dose == selected_dose) %>%
  select(Genes, compound, log2FC) %>%
  pivot_wider(names_from = compound, values_from = log2FC) 

heatmap_full_matrix <- heatmap_full %>%
  filter(!is.na(Genes)) %>%
  distinct(Genes, .keep_all = TRUE) %>%
  column_to_rownames("Genes") %>%
  mutate(
    across(
      everything(),  
      ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
      )
    ) %>%
  as.matrix()

col_annotation_full <- data.frame(
  compound = colnames(heatmap_full_matrix)
  ) %>%
  left_join(compounds_with_MoA %>% select(compound, Type_simp),
            by = "compound") %>%
  select(-compound)
rownames(col_annotation_full) <- colnames(heatmap_full_matrix)

colnames(col_annotation_full) <-"Type"

col_annotation_full

row_annotation <- data.frame(
  Genes = rownames(heatmap_full_matrix)
) %>%
  left_join(GO_group_biggest %>% select(Genes, Description),
            by = "Genes") %>%
  column_to_rownames("Genes") %>%
  mutate(Description = case_when(
    is.na(Description) ~ "NA",
    TRUE ~ Description
    )
  )

pheatmap(
  heatmap_full_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  main = paste0("Hierarchical Clustering of log2FC ", selected_dose, " (nm)"),
  na_col = "grey80",
  show_rownames = F,  # Remove row labels
  show_colnames = F,   # Remove column labels
  annotation_col = col_annotation_full,
  #legend_labels = "Type",
  annotation_row = row_annotation
)
```

### Thalidomide
```{r}
selected_compounds <- 'Thalidomide'
heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  .[rowSums(. == -Inf | is.na(.)) == 0, ] %>%
  mutate(
    across(
      everything(),
     ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
    )
  ) %>%
  #mutate(
  #  across(
  #    everything(),  
  #    ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
  #    )
  #  ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
)
rownames(compound_group) <- colnames(heatmap_data_matrix)


# Plot
p <- pheatmap::pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  main = paste0("Hierarchical Clustering of the proteins for ", selected_compounds),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  #annotation_col = compound_group, 
  annotation_names_col = FALSE
)

```


```{r}
k_clusters <- 6
row_hclust <- p$tree_row
cluster_assignments <- cutree(row_hclust, k = k_clusters)

# 3. Create row annotation dataframe
row_annotation <- data.frame(Cluster = as.factor(cluster_assignments))
rownames(row_annotation) <- names(cluster_assignments)

cluster_colors <- list(
  Cluster = c(
    "1" = "#0072B2",
    "2" = "#56B4E9",
    "3" = "#CC79A7", 
    "4" = "#009E73",
    "5" = "#E69F00",
    "6" = "#D55E00"
  )
)

# 4. Replot heatmap with row annotation
p <- pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
                    seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  main = paste0("Hierarchical Clustering of the proteins for ", selected_compounds),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_row = row_annotation,
  annotation_names_row = TRUE,
  annotation_colors = cluster_colors
)


```

Visually clusters 2 and three look the most down and upregulated, respectively
```{r}
cluster_gene_list <- list(
  thalomide_clust2_down = names(cluster_assignments[cluster_assignments == 2]),
  thalomide_clust3_up = names(cluster_assignments[cluster_assignments == 3])
)

length(unlist(cluster_gene_list))
```

Replot with only selected clusters
```{r}
#cluster annotation subset
row_annotation_subset <- row_annotation[dplyr::intersect(rownames(row_annotation), unlist(cluster_gene_list)),, drop=FALSE]

cluster_colors_subset <- list(
  Cluster = c(
    "2" = "#56B4E9",
    "3" = "#CC79A7"
  )
)


pheatmap(
  heatmap_data_matrix[rownames(heatmap_data_matrix) %in% unlist(cluster_gene_list),],
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
                    seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  main = paste0("Hierarchical Clustering of the proteins for ", selected_compounds),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_row = row_annotation_subset,
  annotation_names_row = TRUE,
  annotation_colors = cluster_colors_subset
)
```

#### GO enrichment
```{r}
# Example cluster assignments: Cluster 2 and 3
cluster2_genes <- cluster_gene_list$thalomide_clust2_down
cluster3_genes <- cluster_gene_list$thalomide_clust3_up

# Convert gene symbols to Entrez IDs (assuming your gene symbols are in a vector)
# You might want to change this if you already have Entrez IDs or need a different mapping.
gene_symbols <- c(cluster2_genes, cluster3_genes)

# Convert to Entrez IDs using org.Hs.eg.db (human example)
gene_entrez_ids <- bitr(gene_symbols, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# Separate into cluster 2 and cluster 3 gene Entrez IDs
cluster2_entrez <- gene_entrez_ids$ENTREZID[gene_entrez_ids$SYMBOL %in% cluster2_genes]
cluster3_entrez <- gene_entrez_ids$ENTREZID[gene_entrez_ids$SYMBOL %in% cluster3_genes]
```


```{r}
# Perform GO enrichment analysis for cluster 2
go_cluster2 <- enrichGO(
  gene = cluster2_entrez,
  OrgDb = org.Hs.eg.db,
  ont = "BP",  # "BP" for Biological Process, you can also use "MF" for Molecular Function or "CC" for Cellular Component
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE
)
```


```{r}
# Perform GO enrichment analysis for cluster 3
go_cluster3 <- enrichGO(
  gene = cluster3_entrez,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE
)
```

```{r, fig.width=14}
# Plot the top 10 enriched GO terms for cluster 2
barplot(go_cluster2, showCategory = 15, title = "Top GO Terms for Thalidomide Cluster 2 (downregulated)")

dotplot(go_cluster2, showCategory = 15, title = "Top GO Terms for Thalidomide Cluster 2 (downregulated)")

ggsave(
    filename = "plots/thalidomideclust2dotplot.png",
    dpi = 300,
    width = 14,
    height = 7
)

emapplot(pairwise_termsim(go_cluster2))

ggsave(
    filename = "plots/thalidomideclust2network.png",
    dpi = 300,
    width = 14,
    height = 7
)

treeplot(pairwise_termsim(go_cluster2))

ggsave(
    filename = "plots/thalidomideclust2tree.png",
    dpi = 300,
    width = 14,
    height = 7
)

```

```{r, fig.width=14}
# Plot the top 10 enriched GO terms for cluster 2
barplot(go_cluster3, showCategory = 15, title = "Top GO Terms for Thalidomide Cluster 3 (upregulated)")

dotplot(go_cluster3, showCategory = 15, title = "Top GO Terms for Thalidomide Cluster 3 (upregulated)")

ggsave(
    filename = "plots/thalidomideclust3dotplot.png",
    dpi = 300,
    width = 14,
    height = 7
)

emapplot(pairwise_termsim(go_cluster3))

ggsave(
    filename = "plots/thalidomideclust3network.png",
    dpi = 300,
    width = 14,
    height = 7
)

treeplot(pairwise_termsim(go_cluster3))

ggsave(
    filename = "plots/thalidomideclust3tree.png",
    dpi = 300,
    width = 7,
    height = 7
)
```


### Pemrametostat 
```{r}
selected_compounds <- 'Pemrametostat'

heatmap_data <- doseresponse_log2FC %>%
  filter(!is.na(Genes), compound %in% selected_compounds) %>% 
  mutate(compound_dose = paste(compound, dose, sep = "_")) %>%
  select(Genes, compound_dose, log2FC) %>%
  pivot_wider(names_from = compound_dose, values_from = log2FC) 

heatmap_data

heatmap_data_matrix <- heatmap_data %>%
  column_to_rownames("Genes") %>%
  .[rowSums(. == -Inf | is.na(.)) == 0, ] %>%
  mutate(
    across(
      everything(),
     ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
    )
  ) %>%
  #mutate(
  #  across(
  #    everything(),  
  #    ~ replace(replace(., is.infinite(.) & . < 0, min(.[is.finite(.)], na.rm = TRUE)), is.na(.), 0)
  #    )
  #  ) %>%
  as.matrix()

conc_colnames <- heatmap_data %>%
  select(-Genes) %>%
  colnames() %>%
  unique()

compound_group <- data.frame(
  compound = rep(selected_compounds, each = 5)
)
rownames(compound_group) <- colnames(heatmap_data_matrix)


# Plot
p <- pheatmap::pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
             seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  main = paste0("Hierarchical Clustering of the proteins for ", selected_compounds),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  #annotation_col = compound_group, 
  annotation_names_col = FALSE
)

```

```{r}
k_clusters <- 6
row_hclust <- p$tree_row
cluster_assignments <- cutree(row_hclust, k = k_clusters)

# 3. Create row annotation dataframe
row_annotation <- data.frame(Cluster = as.factor(cluster_assignments))
rownames(row_annotation) <- names(cluster_assignments)

cluster_colors <- list(
  Cluster = c(
    "3" = "#0072B2",
    "2" = "#56B4E9",
    "1" = "#CC79A7", 
    "4" = "#009E73",
    "5" = "#E69F00",
    "6" = "#D55E00"
  )
)

# 4. Replot heatmap with row annotation
p <- pheatmap(
  heatmap_data_matrix,
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
                    seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  main = paste0("Hierarchical Clustering of the proteins for ", selected_compounds),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_row = row_annotation,
  annotation_names_row = TRUE,
  annotation_colors = cluster_colors
)

```


Visually clusters 2 and three look the most down and upregulated, respectively
```{r}
cluster_gene_list <- list(
  Pemrametostat_clust1_up = names(cluster_assignments[cluster_assignments == 1]),
  Pemrametostat_clust2_down = names(cluster_assignments[cluster_assignments == 2]),
  Pemrametostat_clust3_down = names(cluster_assignments[cluster_assignments == 3])
)

length(unlist(cluster_gene_list))
```

Replot with only selected clusters
```{r}
#cluster annotation subset
row_annotation_subset <- row_annotation[dplyr::intersect(rownames(row_annotation), unlist(cluster_gene_list)),, drop=FALSE]

cluster_colors_subset <- list(
  Cluster = c(
    "3" = "#0072B2",
    "2" = "#56B4E9",
    "1" = "#CC79A7"
  )
)


pheatmap(
  heatmap_data_matrix[rownames(heatmap_data_matrix) %in% unlist(cluster_gene_list),],
  color = colorRampPalette(c("blue", "white", "red"))(100),
  breaks = unique(c(seq(min(heatmap_data_matrix, na.rm = TRUE), 0, length.out = 51), 
                    seq(0, max(heatmap_data_matrix, na.rm = TRUE), length.out = 51))),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  main = paste0("Hierarchical Clustering of the proteins for ", selected_compounds),
  na_col = "grey80",
  show_rownames = FALSE,
  show_colnames = TRUE,
  annotation_row = row_annotation_subset,
  annotation_names_row = TRUE,
  annotation_colors = cluster_colors_subset
)
```

#### GO enrichment
```{r}
# Example cluster assignments: Cluster 2 and 3
cluster1_genes <- cluster_gene_list$Pemrametostat_clust1_up
cluster2_genes <- cluster_gene_list$Pemrametostat_clust2_down
cluster3_genes <- cluster_gene_list$Pemrametostat_clust3_down

# Convert gene symbols to Entrez IDs (assuming your gene symbols are in a vector)
# You might want to change this if you already have Entrez IDs or need a different mapping.
gene_symbols <- c(cluster1_genes, cluster2_genes,cluster3_genes)

# Convert to Entrez IDs using org.Hs.eg.db (human example)
gene_entrez_ids <- bitr(gene_symbols, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# Separate into cluster 2 and cluster 3 gene Entrez IDs
cluster1_entrez <- gene_entrez_ids$ENTREZID[gene_entrez_ids$SYMBOL %in% cluster1_genes]
cluster2_entrez <- gene_entrez_ids$ENTREZID[gene_entrez_ids$SYMBOL %in% cluster2_genes]
cluster3_entrez <- gene_entrez_ids$ENTREZID[gene_entrez_ids$SYMBOL %in% cluster3_genes]
```

```{r}
# Perform GO enrichment analysis for cluster 2
go_cluster1 <- enrichGO(
  gene = cluster1_entrez,
  OrgDb = org.Hs.eg.db,
  ont = "BP",  # "BP" for Biological Process, you can also use "MF" for Molecular Function or "CC" for Cellular Component
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE
)
```

```{r}
# Perform GO enrichment analysis for cluster 2
go_cluster2 <- enrichGO(
  gene = cluster2_entrez,
  OrgDb = org.Hs.eg.db,
  ont = "BP",  # "BP" for Biological Process, you can also use "MF" for Molecular Function or "CC" for Cellular Component
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE
)
```


```{r}
# Perform GO enrichment analysis for cluster 3
go_cluster3 <- enrichGO(
  gene = cluster3_entrez,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  readable = TRUE
)
```

```{r, fig.width=14}
barplot(go_cluster1, showCategory = 15, title = paste0("Top GO terms for cluster 1"))

dotplot(go_cluster1, showCategory = 15, title = paste0("Top GO terms for cluster 1"))

emapplot(pairwise_termsim(go_cluster1))

treeplot(pairwise_termsim(go_cluster1))
```

```{r, fig.width=14}
barplot(go_cluster2, showCategory = 15, title = paste0("Top GO terms for cluster 2"))

dotplot(go_cluster2, showCategory = 15, title = paste0("Top GO terms for cluster 2"))

emapplot(pairwise_termsim(go_cluster2))

treeplot(pairwise_termsim(go_cluster2))
```

```{r, fig.width=14}
barplot(go_cluster3, showCategory = 15, title = paste0("Top GO terms for cluster 3"))

dotplot(go_cluster3, showCategory = 15, title = paste0("Top GO terms for cluster 3"))

emapplot(pairwise_termsim(go_cluster3))

treeplot(pairwise_termsim(go_cluster3))
```

