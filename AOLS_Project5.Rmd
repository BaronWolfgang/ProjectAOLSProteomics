# Decrypting the molecular basis of cellular drug phenotypes by dose-resolved expression proteomics
A very interesting article that demonstrates the Omics (with a capital O) character of Proteomics is [Decrypting the molecular basis of cellular drug phenotypes by dose-resolved expression proteomics](https://pmc.ncbi.nlm.nih.gov/articles/PMC11919725/){.uri}, published in Nature Biotechnology in March 2024. Here, the authors measure the protein expression of more than 8000 protein groups after exposing cell lines to 144 different drugs for a period of 18 hours. They use this data to calculate dose response curves for all of the proteins.

Please familiarize yourself with the article, we'll try to reproduce some plots from it.

# Software needed
## File download software
For downloading the data you will need an FTP (file transfer protocol) client. For windows, you can obtain Filezilla client (take care not to install extra software that is sometimes offered in the installer). Macintosh users have a built-in FTP client under connect to server, prefix the URL with ftp://.

## R
Since you are reading this in Rmd, it should be obvious you need R and probably RStudio. The following packages need to be installed: drc for dose response curve calculation tidyverse packages: readr, readxl, tidyr, dplyr, purrr, ggplot2

```{r}
base_packages_to_install <- c(
  "readr",
  "readxl",
  "tidyr",
  "dplyr",
  "purrr",
  "ggplot2",
  "drc"
)

my_packages_to_install <- c(
  "conflicted",
  "RCurl",
  "magrittr",
  "stringr",
  "broom"
)

BiocManager_packages_to_install <- c(
  "clusterProfiler" #GO term enrichment analysis from paper
)

packages_to_install <- c(base_packages_to_install, my_packages_to_install)

# Check and install packages using a for loop
for (package in packages_to_install) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
  library(package, character.only = TRUE)
}

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

for (package in BiocManager_packages_to_install) {
  if (!requireNamespace(package, quietly = TRUE)) {
    BiocManager::install(package)
  }
  library(package, character.only = TRUE) 
}
```

## Data
We'd like to re-analyze some data from this article, to try to recreate some dose-response curves. The data is stored in ProteomeXChange, but unfortunately the R package does not support the repository (MassIVE), so we'll need to do some manual work.

In the article, a reference to the dataset is available. Obtain the proteinGroups.txt file from the time dependent dataset.

A 500 Megabytes file with proteinGroups at an FDR of 0.01 can be found in the FTP server of MassIVE in this folder: "/v06/MSV000093659/search/Search results - Long-term performance test Jurkat"

```{r}
# Define folder name
data_dir <- "data"

# Create folder if it doesn't exist
if (!dir.exists(data_dir)) {
  dir.create(data_dir)
  cat("Created 'data' folder\n")
} else {
  cat("'data' folder already exists\n")
}
```

```{r}
txt_file <- paste0(data_dir,"/proteinGroups_fdr0.01.txt")

if (!file.exists(txt_file)) {
  # If the file does not exist, download it
  ftp_url_txt <- URLencode("ftp://massive-ftp.ucsd.edu/v06/MSV000093659/search/Search results - Long-term performance test Jurkat/Picked FDR PG/proteinGroups_fdr0.01.txt")
  download.file(ftp_url_txt, destfile = txt_file, mode = "wb")
  cat("Downloaded proteinGroups_fdr0.01.txt to 'data/' folder\n")
} else {
  cat("File already exists in 'data/' folder, skipping download.\n")
}
```

Read the file into R. Rename the headers of the Gene names table to be more easily used in the rest of the script.
```{r}
doseresponse <- read_delim(txt_file) %>%
  rename(Genes = `Gene names`)
head(doseresponse)
```

The drug names are given as numbers, so we will need to obtain the names from the metadata data found in the MassIVE repository.
```{r}
xlsx_file <- file.path(data_dir, "MassIVE_MappingSheet.xlsx")

if (!file.exists(xlsx_file)) {
  ftp_url_xlsx <- URLencode(
    "ftp://massive-ftp.ucsd.edu/v06/MSV000093659/metadata/MassIVE_MappingSheet.xlsx"
  )
  download.file(ftp_url_xlsx, destfile = xlsx_file, mode = "wb")
  cat("Downloaded MassIVE_MappingSheet.xlsx to 'data/' folder\n")
} else {
  cat("File 'MassIVE_MappingSheet.xlsx' already exists, skipping download.\n")
}

drugs <- read_xlsx(xlsx_file, sheet=2, skip=1, col_names = c("Drug", "Number")) %>% 
  pull(Drug)
```

If you have a look at the dimensions of the dataset, it's clear that there are a massive amount of columns. 

```{r}
dim(doseresponse)
```

We don't need all of them, use the tidyverse `select` function to obtain the colums that contain protein names, descriptions, and LFQ values.
```{r}
head(doseresponse)
```


```{r}
dmso <- doseresponse %>%
  select(Genes, starts_with("LFQ") & contains("DMSO"))

doseresponse <- doseresponse %>%
  select(c(Genes), starts_with("LFQ")) %>%
  select(-(contains("DMSO")))
```

## Tidying and normalization
Use dplyr to make a long-form dataset with the data points coming from the LFQ columns. We'll need to split the column names into their separate parts, this can be done with the `separate` command.

According to the methods, the protein values are divided by the mean DMSO expression value.
```{r}
dmso_tidy <- dmso %>% pivot_longer(-Genes) %>% summarize(.by=Genes, mean_dmso = mean(value, na.rm=TRUE)) %>% select(Genes, mean_dmso)

tidy_doseresponse <- doseresponse %>%
  pivot_longer(starts_with("LFQ")) %>%
  separate(name, sep=" ", into=c(NA, NA, "compound", "dose")) %>%
  mutate(compound = drugs[as.numeric(compound)], dose = as.numeric(dose))

tidy_doseresponse %<>% left_join(dmso_tidy, by="Genes")

doseresponse_norm <- tidy_doseresponse %>%
  mutate(.by=c(Genes, compound), value = value / mean_dmso) %>%
  select(-mean_dmso)
```

We also need to add a zero-concentration value for the curves, so we have a common starting point.
```{r}
zero_values <- doseresponse_norm %>% summarize(.by = c(Genes, compound), dose=0.1, value=1)

doseresponse_norm %<>% bind_rows(zero_values)
```

### Example plot
Here is an example plot reproduction of the article.
```{r, example}
doseresponse_norm %>%
  filter(
    Genes %in% c("BAG3", "DNAJB1", "DNAJB4", "HSPA1A;HSPA1B"),
    compound =="Geldanamycin"
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10()
```

#### redoing example
NOTE: I don't see DNAJB1 or DNAJB2 at all:
```{r}
doseresponse_norm %>% select(Genes) %>% unique() %>% filter(str_detect(Genes, "DNAJB")) %>% arrange(Genes)
```
```{r, adjusted}
selected_genes <- c("BAG3", "DNAJB11", "DNAJB14", "HSPA1A;HSPA1B")
selected_compounds <- c("Geldanamycin")

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )
```

# Assignment
Given this dataset, try to do the following:
- Reproduce some of the dose-response curves, or try to find some that have proteins that have relatively high or low values in the higher drug concentration regimes
- Create a heatmap for the proteins for one or more selected drugs, across the relative concentration range
Perform hierarchical clustering separately for the clusters you observe, have a look over here: https://www.statology.org/hierarchical-clustering-in-r/
- use a GO annotation tool to find out if you observe some interesting enrichment in your clusters, and try to link the action of the drug(s) to the observed terms.

## 1. Reproducing dose-response curves
Generalized curve plotting methods:
```{r}
selected_genes <- c("BAG3", "DNAJB11", "DNAJB14", "HSPA1A;HSPA1B")
selected_compounds <- c("Geldanamycin")
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1] #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )
```

### random subset
```{r}
length(unique(doseresponse_norm$Genes))
length(unique(doseresponse_norm$compound))
```

```{r}
set.seed(123)

selected_genes <- sample(unique(doseresponse_norm$Genes), 5)
selected_compounds <- sample(unique(doseresponse_norm$compound), 9)
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1] #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )
```

### Manual checking
```{r}
doseresponse_norm %>% select(Genes) %>% unique() %>% 
  filter(str_detect(Genes, "RRM")) %>% 
  arrange(Genes)

doseresponse_norm %>% select(compound) %>% unique() %>% 
  #filter(str_detect(compound, "")) %>% 
  arrange(compound)
```

```{r}
#Selected genes and compounds from Fig.3a
selected_genes <- c("HDAC1", "RRM2", "BAG3", "DNMT1", "DHFR")
selected_compounds <- c("Vorinostat", "Palbociclib", "Carfilzomib", "Decitabine", "Methotrexate")
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1]  #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    )

figure_3a_map <- data.frame(
  compound = selected_compounds,
  Genes = selected_genes
)

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  semi_join(figure_3a_map, by = c("compound", "Genes")) %>%
  ggplot(aes(x=dose, y=value, col = Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = rep(palette.colors()[6], length(selected_genes))) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(compound~Genes, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line(),
      legend.position = "none"
    )


```

```{r}
#Selected genes and compounds from Fig.3b
selected_genes <- doseresponse_norm %>% select(Genes) %>% unique() %>% 
  filter(str_detect(Genes, "CLK")) %>% 
  arrange(Genes) %>% pull()
selected_compounds <- c("Brigatinib")
selected_palette <- palette.colors(length(unique(selected_genes))+1)[-1]  #Okabe-Ito minus black

doseresponse_norm %>%
  filter(
    Genes %in% selected_genes,
    compound %in% selected_compounds
    ) %>%
  ggplot(aes(x=dose, y=value, col=Genes)) +
    geom_smooth(method=drm, method.args=list(fct=L.4()), se=FALSE) +
    geom_point() +
    scale_x_log10(breaks = c(0.1,1, 10, 100, 1000, 10000), 
                  labels = scales::comma_format(),
                  expand = c(0, 0)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_color_manual(values = selected_palette) +
    labs(
      x="concentration (nM)",
      y="Relative intensity",
      color = "Proteins"
      ) +
    facet_wrap(~compound, scales = "free_y") +
    theme_minimal() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),  
      axis.line = element_line(),          
      axis.ticks = element_line()          
    ) 
```


## 2. Create heatmap
For the heatmap in the paper: The heatmap depicts the combined, preprocessed GO term enrichment results after hierarchically clustering of both rows and columns using Pearson correlation as a distance metric and Weighted Pair Group Method with arithmetic mean as the agglomerative method.

```{r}
doseresponse_norm %>% filter(dose == 1e-01) 
```


Comparison data
```{r}
comparison_data <- doseresponse_norm %>%
  filter(dose %in% c(1e-1, 10000), # we want to compare highest vs lowest (baseline) conditions
         !is.na(value) #there are 3,060 na's
         ) %>%
  group_by(Genes, compound) %>%
  mutate(n = n()) %>%
  filter(n == 2) %>%
  select(-n) %>%
  arrange(compound, Genes)

comparison_data
  
```

Run linear model
```{r}
lm_results <- comparison_data %>%
  group_by(Genes, compound) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(value ~ dose, data = .x)),
    results = map(model, tidy)
  ) %>%
  unnest(results)

lm_results
```


## 3. Gene annotation
In the paper GO term enrichment analysis was performed for each drug individually using the clusterProfiler R package (v.4.2.2.). Each drug dataset was tested for enrichment of GO terms on all levels (cellular compartment, molecular function and biological process) both in up- and down-regulated proteins with the whole drug dataset as the background. P values were corrected using the FDR approach and the q value cut-off was set to 1. The enrichment results for up-and down-regulation were combined, retaining the more significant entry for duplications. After combining the enrichment results for all drugs, the q values were log transformed, multiplied by −1 for GO terms enriched in down-regulation and z-scored for each GO term individually

A second GO term enrichtment analysis was done(P value cut-off, 0.05; P value correction, FDR approach; Subontology, Molecular Function; whole H. sapiens database as background)

Either clusterProfiler or topGO for GO term enrichtment.

## Other things we could look at
For the volcano plot displayed in Extended Data Fig. 2b assessing the quantitative reproducibility, the 48 DMSO controls were randomly assigned into two equally sized groups. After median centering normalization of the LFQ intensities of the picked FDR gene group output and filtering for completeness in the dataset, a two-sided Student’s t-test was performed for all 4,694 proteins. P values were corrected for multiple hypothesis testing using the FDR approach using the R package fdrtool (v.1.2.17).